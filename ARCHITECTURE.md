# 系统架构设计文档

## 1. 系统概述

本系统是一个基于 LangGraph 的多角色协作智能客服系统，采用多智能体架构，通过状态管理和条件路由实现智能体间的协作。

### 1.1 核心特性

- **多智能体协作**：三个专业化智能体（接待员、问题分析师、解决方案专家）协同工作
- **状态管理**：基于 LangGraph 的状态管理机制，确保数据在智能体间正确传递
- **条件路由**：根据问题类型和复杂度动态路由到不同的智能体
- **工具集成**：集成 MCP 工具（知识库查询、订单查询）
- **记忆持久化**：支持多轮对话，对话历史持久化存储
- **人机协同**：支持人工介入机制

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户接口层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  命令行交互  │  │  FastAPI     │  │  未来扩展    │   │
│  │   (main.py) │  │   (app.py)   │  │              │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  LangGraph 工作流层                       │
│  ┌──────────────────────────────────────────────────┐  │
│  │         CustomerServiceGraph                      │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐      │  │
│  │  │接待员节点│→ │分析师节点│→ │专家节点  │      │  │
│  │  └──────────┘  └──────────┘  └──────────┘      │  │
│  │       │              │              │            │  │
│  │       └──────────────┴──────────────┘            │  │
│  │                    │                              │  │
│  │              ┌─────────┐                        │  │
│  │              │工具节点 │                        │  │
│  │              └─────────┘                        │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  智能体层     │  │   工具层      │  │   记忆层      │
│              │  │              │  │              │
│ ┌──────────┐ │  │ ┌──────────┐ │  │ ┌──────────┐ │
│ │接待员智能体│ │  │ │知识库工具│ │  │ │记忆存储  │ │
│ └──────────┘ │  │ └──────────┘ │  │ └──────────┘ │
│ ┌──────────┐ │  │ ┌──────────┐ │  │ ┌──────────┐ │
│ │分析师智能体│ │  │ │订单查询  │ │  │ │对话管理  │ │
│ └──────────┘ │  │ └──────────┘ │  │ └──────────┘ │
│ ┌──────────┐ │  │              │  │              │
│ │专家智能体 │ │  │              │  │              │
│ └──────────┘ │  │              │  │              │
└──────────────┘  └──────────────┘  └──────────────┘
```

### 2.2 核心组件

#### 2.2.1 智能体层 (Agents)

**BaseAgent（基类）**
- 提供统一的智能体接口
- 处理 LLM 调用
- 管理对话历史和上下文

**ReceptionistAgent（接待员）**
- 职责：用户接待、问题初步分类、引导
- 输出：问题类别、紧急程度、是否需要深入分析

**AnalystAgent（问题分析师）**
- 职责：深入分析问题、提取关键信息
- 输出：问题摘要、根本原因、关键参数、复杂度评估

**SolutionExpertAgent（解决方案专家）**
- 职责：生成解决方案、提供操作步骤
- 输出：解决方案、操作步骤、预防措施

#### 2.2.2 工作流层 (Workflow)

**CustomerServiceGraph**
- 基于 LangGraph 构建的工作流图
- 管理智能体间的状态传递
- 实现条件路由和动态决策

**工作流节点：**
1. `receptionist` - 接待员节点
2. `analyst` - 问题分析师节点
3. `solution_expert` - 解决方案专家节点
4. `call_tools` - 工具调用节点
5. `human_intervention` - 人工介入节点

**路由决策：**
- `_route_after_receptionist`: 根据问题是否需要分析决定路由
- `_route_after_analyst`: 根据问题复杂度决定是否调用工具
- `_route_after_tools`: 根据工具调用结果决定下一步
- `_route_after_solution`: 根据解决方案复杂度决定是否需要人工确认

#### 2.2.3 工具层 (Tools)

**MCPToolManager**
- 管理所有 MCP 工具
- 提供统一的工具调用接口

**KnowledgeBaseTool（知识库工具）**
- 查询知识库获取相关信息
- 支持按类别查询

**OrderQueryTool（订单查询工具）**
- 查询订单信息
- 返回订单状态、配送信息等

#### 2.2.4 记忆层 (Memory)

**MemoryStore**
- 基于 SQLite 的持久化存储
- 存储会话和消息历史
- 支持多轮对话

**ConversationManager**
- 管理对话上下文
- 提供对话总结功能

## 3. 数据流

### 3.1 状态流转

```
用户输入
  │
  ▼
接待员节点
  │
  ├─→ [简单问题] → 直接回复 → END
  │
  └─→ [复杂问题] → 问题分析师节点
                    │
                    ├─→ [需要工具] → 工具调用节点
                    │                 │
                    │                 └─→ 解决方案专家节点
                    │                         │
                    │                         ├─→ [需要确认] → 人工介入 → END
                    │                         │
                    │                         └─→ END
                    │
                    └─→ [不需要工具] → 解决方案专家节点
```

### 3.2 状态数据结构

```python
CustomerServiceState:
  - user_id: 用户ID
  - user_input: 用户输入
  - conversation_history: 对话历史
  - receptionist_result: 接待员处理结果
  - analysis_result: 分析师处理结果
  - solution_result: 专家处理结果
  - tool_results: 工具调用结果
  - current_agent: 当前智能体
  - next_agent: 下一个智能体
  - is_complete: 是否完成
  - needs_human_intervention: 是否需要人工介入
  - context: 上下文信息
  - error: 错误信息
  - retry_count: 重试次数
  - session_id: 会话ID
  - created_at: 创建时间
  - updated_at: 更新时间
```

## 4. 关键技术实现

### 4.1 LangGraph 状态管理

使用 LangGraph 的 `StateGraph` 和 `TypedDict` 实现类型安全的状态管理：

```python
from langgraph.graph import StateGraph
from typing import TypedDict

class CustomerServiceState(TypedDict):
    user_input: str
    conversation_history: List[Dict]
    # ... 其他状态字段
```

### 4.2 条件路由

使用 `add_conditional_edges` 实现动态路由：

```python
workflow.add_conditional_edges(
    "receptionist",
    self._route_after_receptionist,
    {
        "analyst": "analyst",
        "solution_expert": "solution_expert",
        "end": END
    }
)
```

### 4.3 记忆持久化

使用 SQLite 存储对话历史，支持多轮对话：

```python
# 保存消息
await memory_store.save_message(
    user_id=user_id,
    session_id=session_id,
    role="user",
    content=message
)

# 加载历史
history = await memory_store.get_conversation_history(
    user_id=user_id,
    session_id=session_id
)
```

### 4.4 MCP 工具集成

通过 MCP 协议集成外部工具：

```python
# 调用知识库工具
result = await tool_manager.query_knowledge_base(
    query=user_input,
    category=problem_category
)

# 调用订单查询工具
order_info = await tool_manager.query_order(order_id)
```

## 5. 扩展性设计

### 5.1 添加新智能体

1. 继承 `BaseAgent` 类
2. 实现 `process` 方法
3. 在工作流图中添加新节点
4. 配置路由规则

### 5.2 添加新工具

1. 创建工具类（继承或实现工具接口）
2. 在 `MCPToolManager` 中注册
3. 在工作流中调用

### 5.3 支持新的 LLM 提供商

1. 在 `create_llm` 函数中添加新的提供商支持
2. 配置相应的 API 密钥

## 6. 性能优化

### 6.1 缓存机制

- 对话历史缓存（限制最近 N 条）
- 知识库查询结果缓存

### 6.2 异步处理

- 所有 I/O 操作使用异步
- 工具调用并行执行（如需要）

### 6.3 数据库优化

- 使用索引加速查询
- 定期清理旧数据

## 7. 安全性考虑

### 7.1 输入验证

- 验证用户输入长度和格式
- 防止 SQL 注入（使用参数化查询）

### 7.2 API 安全

- API 密钥管理
- 请求频率限制
- CORS 配置

### 7.3 数据隐私

- 敏感信息脱敏
- 对话数据加密存储（可选）

## 8. 部署架构

### 8.1 开发环境

```
本地开发
  ├─ Python 3.11+
  ├─ SQLite 数据库
  └─ 本地 LLM API
```

### 8.2 生产环境

```
Docker 容器
  ├─ FastAPI 应用
  ├─ PostgreSQL 数据库
  ├─ Redis 缓存（可选）
  └─ 外部 LLM API
```

## 9. 监控和日志

### 9.1 日志记录

- 使用 `loguru` 进行结构化日志
- 记录关键操作和错误

### 9.2 性能监控

- 记录每个节点的执行时间
- 监控 LLM API 调用延迟
- 跟踪工具调用成功率

## 10. 未来改进方向

1. **多模态支持**：支持图片、语音输入
2. **情感分析**：识别用户情绪，调整回复策略
3. **学习机制**：从历史对话中学习，优化回复质量
4. **分布式部署**：支持多实例部署，负载均衡
5. **实时流式响应**：支持流式输出，提升用户体验
